<?php
$site = $site ?? null;
$siteTitle = $site ? $site->title() : 'Site';
$escape = $this->plugin('escapeHtml');
$navPages = $site->publicNav()->getPages();
$topLevelLabels = ['Home', 'All Funds', 'About', 'Contact'];
?>

<header class="site-header">
  <div class="header-inner">

    <!-- Site Logo -->
    <a href="<?= $site->url(); ?>" class="site-logo" aria-label="<?= $escape($siteTitle); ?>">
      <?php if ($this->themeSetting('logo')): ?>
        <img src="<?= $this->themeSettingAssetUrl('logo'); ?>" alt="<?= $escape($siteTitle); ?>">
      <?php else: ?>
        <span class="text-logo"><?= $escape($siteTitle); ?></span>
      <?php endif; ?>
    </a>

    <!-- Mobile Toggle -->
    <button class="mobile-nav-toggle" aria-label="<?= $this->translate('Toggle navigation'); ?>">
      â˜°
    </button>

    <!-- Navigation -->
    <nav class="main-nav" aria-label="Main Navigation">
      <ul class="nav-links">
        <?php foreach ($navPages as $page):
          $label = $escape($page->getLabel());
          $isActive = $page->isActive() ? 'active' : '';
          if (!in_array($label, $topLevelLabels)) continue;

          $hasSubmenu = $page->hasPages();
          $class = 'nav-item' . ($hasSubmenu ? ' has-submenu' : '');
        ?>
          <li class="<?= $class ?>">
            <a href="<?= $escape($page->getHref()) ?>" class="nav-link <?= $isActive ?>">
              <?= $label ?>
            </a>

            <?php if ($hasSubmenu): ?>
              <ul class="sub-menu">
                <?php foreach ($page->getPages() as $subPage): ?>
                  <li><a href="<?= $escape($subPage->getHref()) ?>"><?= $escape($subPage->getLabel()) ?></a></li>
                <?php endforeach; ?>
              </ul>
            <?php endif; ?>
          </li>
        <?php endforeach; ?>
      </ul>
    </nav>

    <!-- Search - moved after nav for mobile layout -->
    <div class="site-search">
      <?= $this->partial('common/search-form'); ?>
    </div>

  </div>
</header>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.querySelector(".mobile-nav-toggle");
    const nav = document.querySelector(".main-nav");
    const search = document.querySelector(".site-search");

    // Toggle mobile menu
    toggle?.addEventListener("click", () => {
      nav.classList.toggle("mobile-nav-open");
      // Also toggle search visibility on mobile
      if (window.innerWidth <= 768) {
        search.style.display = nav.classList.contains("mobile-nav-open") ? "block" : "none";
      }
    });

    // Handle dropdown toggles on mobile
    document.querySelectorAll(".has-submenu > .nav-link").forEach(link => {
      link.addEventListener("click", function(e) {
        const parent = this.closest(".has-submenu");
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
          e.preventDefault();
          parent.classList.toggle("open");
          
          // Close other open dropdowns
          document.querySelectorAll(".has-submenu").forEach(item => {
            if (item !== parent) {
              item.classList.remove("open");
            }
          });
        }
      });
    });

    // Handle window resize
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.innerWidth > 768) {
          nav.classList.remove("mobile-nav-open");
          search.style.display = "";
          document.querySelectorAll(".has-submenu").forEach(item => {
            item.classList.remove("open");
          });
        }
      }, 250);
    });
  });
</script>